# C#开发性能优化指导原则

华为公司的[C语言编程规范](https://ilcc.gitbooks.io/wiki/content/StyleGuide/Huawei-C/index.html)的开头就强调了：
> 一般情况下，代码的可阅读性高于性能，只有确定性能是瓶颈时，才应该主动优化。

另外，本文讲述的原则也没有经过大项目和大公司的检验，所以，请批判性地阅读本文。本文中的部分结论有测试代码支持，参见SpeedTest.cs. 虽然C#的编译器会在release版本中执行一些优化，C#的运行时也有一些优化，但偶尔会遇到debug版本正常，而release版本异常的问题，比如我在github上fork了已停止维护的屏幕录像软件[Captura](https://github.com/FrogGuaGuaGua/Captura)，debug模式能启动，release版本无法启动，我短时间内解决不了这个问题，如果要发布，只能发布debug版本。所以手工执行一些虽然编译器(在release版本中)会做但也简单易读的优化，还是有意义的。

1. 整数乘以或除以$2^n$ (n也是整数)，使用移位来代替。但对乘除非 $2^n$ 的整数不要使用此方法，比如不要把 i * 12 改写成 (i << 2 + i << 3).

20. 除以浮点型常数的除法，改写为乘以这个数的倒数。比如把 x / 2.0 改写为 x * 0.5  .

30. 绝大多数情况下都应该使用double型浮点数，避免使用float型。因为新出的电脑和手机都是64位处理器，都有硬件浮点单元，并针对double型进行了额外的优化，float型的计算速度有时甚至比double型更慢。如果没有大量的浮点数参与运算或需要存储，float型节省存储空间的优势也没有意义。float型的精度太差，可能带来一些难以察觉的bug，比如 for(float i = 0.0f; i < 20_000_000; i++){} 就是一个难以察觉的死循环，当 i 达到16777216时，会由于float的精度太低，无法区分16777216和16777217，即无法自增1. 另外，使用float型，所有的字面量都要加 f 后缀，所有的数学库函数前面都要加(float)进行强制类型转换，写起来麻烦，看起来丑陋，所以要尽量避免。在以下情形(但不限于)可考虑使用float型：
    * 训练AI模型，数据量巨大但对计算精度要求不高，float型可显著节省存储空间。
    * 程序要在32位处理器上运行，或者要在没有硬件浮点单元的处理器上运行。	

40. 计算$x^n$，当$n=2,3$时，不要使用Math.Pow(x,n), 而是直接写成 x * x 和 x * x * x. 当 n 取其它值时才可调用Math.Pow.

50. 引入一些额外的变量来存储函数调用的结果，或者复杂运算过程中的子过程的值，避免重复调用和计算。比如计算二维坐标旋转: $ x'=x\cos\theta-y\sin\theta,\ y'=x\sin\theta+y\cos\theta$，同一个角的正弦和余弦值都要使用两次。计算二次方程的根，$\frac{\sqrt{\Delta}}{2a}$会使用两次。